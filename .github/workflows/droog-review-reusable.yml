name: Droog AI Review (Reusable)

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: string
      gemini_api_key:
        description: 'Gemini API key'
        required: true
        type: string
      github_token:
        description: 'GitHub token'
        required: true
        type: string
      post_comments:
        description: 'Post comments to PR'
        required: false
        type: boolean
        default: true
    secrets:
      GEMINI_API_KEY:
        required: true
      GITHUB_TOKEN:
        required: true

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      # Step 1: Checkout DroogAI repository (to build it)
      - name: Checkout DroogAI
        uses: actions/checkout@v4
        with:
          repository: abhijeet1771/DROOGAI
          path: .droog-ai
          ref: master
      
      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: .droog-ai/package-lock.json
        continue-on-error: true
      
      # Step 3: Install DroogAI dependencies
      - name: Install DroogAI dependencies
        working-directory: .droog-ai
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi
      
      # Step 4: Build DroogAI
      - name: Build DroogAI
        working-directory: .droog-ai
        run: npm run build
      
      # Step 5: Verify build
      - name: Verify DroogAI build
        working-directory: .droog-ai
        run: |
          if [ ! -f "dist/index.js" ]; then
            echo "âŒ DroogAI build failed - dist/index.js not found"
            exit 1
          fi
          echo "âœ… DroogAI built successfully"
      
      # Step 6: Checkout calling repository (the repo being reviewed)
      - name: Checkout calling repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Step 7: Load index if exists (from calling repo)
      - name: Load index if exists
        id: load-index
        run: |
          if [ -f ".droog-embeddings.json" ]; then
            echo "index_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Codebase index found"
          else
            echo "index_exists=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No codebase index found (will skip cross-repo duplicate detection)"
          fi
        continue-on-error: true
      
      # Step 8: Run DroogAI Review on calling repository
      - name: Run DroogAI Review
        id: review
        working-directory: .droog-ai
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ inputs.pr_number }}"
          POST_FLAG=""
          if [ "${{ inputs.post_comments }}" = "true" ]; then
            POST_FLAG="--post"
          fi
          
          echo "ðŸš€ Running DroogAI review on ${{ github.repository }} PR #${PR_NUMBER}"
          
          # Run review with enterprise features enabled
          node dist/index.js review --repo "${{ github.repository }}" --pr "${PR_NUMBER}" --enterprise ${POST_FLAG} || true
          
          # Copy report.json to calling repo root for artifact upload
          if [ -f "report.json" ]; then
            cp report.json "${{ github.workspace }}/report.json"
            echo "âœ… Review report generated"
          else
            echo "âš ï¸  report.json not found, creating minimal error report"
            echo '{"success":false,"error":"Review failed to generate report","totalIssues":0,"issuesBySeverity":{"high":0,"medium":0,"low":0},"comments":[],"timestamp":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}' > "${{ github.workspace }}/report.json"
          fi
      
      - name: Upload review report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: review-report
          path: report.json
          retention-days: 7
          if-no-files-found: warn

