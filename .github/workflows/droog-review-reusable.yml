name: Droog AI Review (Reusable)

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: string
      post_comments:
        description: 'Post comments to PR'
        required: false
        type: boolean
        default: true
      auto_fix:
        description: 'Generate auto-fix suggestions'
        required: false
        type: boolean
        default: false
      auto_apply:
        description: 'Automatically apply low-risk fixes'
        required: false
        type: boolean
        default: false
    secrets:
      GEMINI_API_KEY:
        required: true

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      # Step 1: Checkout DroogAI repository (to build it)
      - name: Checkout DroogAI
        uses: actions/checkout@v4
        with:
          repository: abhijeet1771/DROOGAI
          path: .droog-ai
          ref: master
      
      # Step 1.5: Verify DroogAI checkout
      - name: Verify DroogAI checkout
        run: |
          if [ ! -d ".droog-ai" ]; then
            echo "âŒ DroogAI directory not found after checkout"
            exit 1
          fi
          if [ ! -f ".droog-ai/package.json" ]; then
            echo "âŒ package.json not found in DroogAI repository"
            echo "Current directory: $(pwd)"
            echo "Contents of .droog-ai:"
            ls -la .droog-ai/ | head -20
            exit 1
          fi
          echo "âœ… DroogAI checkout verified - package.json found"
      
      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: .droog-ai/package-lock.json
        continue-on-error: true
      
      # Step 3: Install DroogAI dependencies
      - name: Install DroogAI dependencies
        working-directory: .droog-ai
        run: |
          echo "ðŸ“¦ Installing DroogAI dependencies..."
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi
          echo "âœ… Dependencies installed successfully"
      
      # Step 4: Build DroogAI
      - name: Build DroogAI
        working-directory: .droog-ai
        run: npm run build
      
      # Step 5: Verify build
      - name: Verify DroogAI build
        working-directory: .droog-ai
        run: |
          if [ ! -f "dist/index.js" ]; then
            echo "âŒ DroogAI build failed - dist/index.js not found"
            exit 1
          fi
          echo "âœ… DroogAI built successfully"
      
      # Step 6: Checkout calling repository (the repo being reviewed) to preserve .droog-ai
      - name: Checkout calling repository
        uses: actions/checkout@v4
        with:
          path: repo
          fetch-depth: 0
      
      # Step 6.5: Verify .droog-ai still exists after checkout
      - name: Verify .droog-ai directory exists
        run: |
          if [ ! -d ".droog-ai" ]; then
            echo "âŒ .droog-ai directory not found after checkout"
            echo "Current directory: $(pwd)"
            echo "Contents of workspace:"
            ls -la
            exit 1
          fi
          if [ ! -f ".droog-ai/dist/index.js" ]; then
            echo "âŒ DroogAI build not found in .droog-ai/dist/index.js"
            exit 1
          fi
          echo "âœ… .droog-ai directory verified - dist/index.js found"
      
      # Step 7: Index main/master branch before review (FORCE INDEX CREATION)
      - name: Index main branch for review
        id: index-repo
        working-directory: .droog-ai
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "=========================================="
          echo "ðŸ“¦ FORCE INDEXING - Main/Master Branch"
          echo "=========================================="
          echo "   Current directory: $(pwd)"
          echo "   Repository: ${{ github.repository }}"
          echo "   Working directory contents:"
          ls -la | head -10
          
          # Ensure we're in the right directory
          if [ ! -f "dist/index.js" ]; then
            echo "âŒ ERROR: dist/index.js not found in $(pwd)"
            echo "   Contents:"
            ls -la
            exit 1
          fi
          
          # Determine base branch - try main first, then master
          BASE_BRANCH="main"
          
          # Check which branch exists using GitHub API
          echo "   Checking default branch..."
          RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}" 2>&1)
          
          if [ $? -eq 0 ] && [ -n "$RESPONSE" ]; then
            DEFAULT_BRANCH=$(echo "$RESPONSE" | grep -o '"default_branch":"[^"]*"' | cut -d'"' -f4 || echo "")
            if [ -n "$DEFAULT_BRANCH" ]; then
              BASE_BRANCH="$DEFAULT_BRANCH"
            fi
          else
            echo "   âš ï¸  Could not fetch default branch, using 'main'"
          fi
          
          echo "   Using base branch: ${BASE_BRANCH}"
          echo ""
          
          # FORCE: Remove any existing index file to start fresh
          if [ -f ".droog-embeddings.json" ]; then
            echo "   Removing existing index file..."
            rm -f .droog-embeddings.json
          fi
          
          # Retry logic: Try indexing up to 3 times with detailed logging
          MAX_RETRIES=3
          RETRY_COUNT=0
          INDEX_SUCCESS=false
          LAST_ERROR=""
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "   ðŸ”„ INDEXING ATTEMPT $RETRY_COUNT/$MAX_RETRIES"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Run indexing with timeout (10 minutes) and capture all output
            echo "   Command: node dist/index.js index --repo ${{ github.repository }} --branch ${BASE_BRANCH}"
            echo "   Starting indexing..."
            
            INDEX_OUTPUT=$(timeout 600 node dist/index.js index --repo "${{ github.repository }}" --branch "${BASE_BRANCH}" 2>&1)
            INDEX_EXIT_CODE=$?
            
            echo "   Exit code: ${INDEX_EXIT_CODE}"
            echo "   Output (last 50 lines):"
            echo "$INDEX_OUTPUT" | tail -50
            
            if [ $INDEX_EXIT_CODE -eq 0 ]; then
              # Check if index file was created
              sleep 2  # Wait a bit for file system sync
              
              if [ -f ".droog-embeddings.json" ]; then
                FILE_SIZE=$(stat -f%z .droog-embeddings.json 2>/dev/null || stat -c%s .droog-embeddings.json 2>/dev/null || echo "0")
                echo "   Index file found! Size: ${FILE_SIZE} bytes"
                
                if [ "$FILE_SIZE" -gt 100 ]; then
                  echo "   âœ… Index file is valid (size > 100 bytes)"
                  INDEX_SUCCESS=true
                  break
                else
                  echo "   âš ï¸  Index file too small (${FILE_SIZE} bytes), will retry..."
                  rm -f .droog-embeddings.json
                  LAST_ERROR="Index file too small"
                fi
              else
                echo "   âš ï¸  Index file not found after indexing, will retry..."
                LAST_ERROR="Index file not created"
              fi
            else
              echo "   âš ï¸  Indexing command failed (exit code: ${INDEX_EXIT_CODE})"
              LAST_ERROR="Command failed with exit code ${INDEX_EXIT_CODE}"
              echo "   Error output:"
              echo "$INDEX_OUTPUT" | grep -i "error\|fail\|exception" | head -10 || echo "   (no specific error messages found)"
            fi
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "   Waiting 10 seconds before retry..."
              sleep 10
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "   ðŸ“Š INDEXING SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # FORCE CREATE: Ensure index file exists no matter what
          if [ "$INDEX_SUCCESS" = false ]; then
            echo "   âš ï¸  All indexing attempts failed"
            echo "   Last error: ${LAST_ERROR}"
            echo "   Creating minimal index file as fallback..."
            
            TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            # Escape LAST_ERROR for JSON
            ESCAPED_ERROR=$(echo "${LAST_ERROR}" | sed 's/"/\\"/g')
            echo "{\"version\":\"1.0\",\"repository\":\"${{ github.repository }}\",\"branch\":\"${BASE_BRANCH}\",\"timestamp\":\"${TIMESTAMP}\",\"embeddings\":[],\"metadata\":{\"note\":\"Minimal index created due to indexing failure\",\"error\":\"${ESCAPED_ERROR}\",\"files_indexed\":0,\"symbols_indexed\":0,\"retries_attempted\":${MAX_RETRIES}}}" > .droog-embeddings.json
            echo "   âœ… Minimal index file created"
          fi
          
          # FINAL VERIFICATION - Index file MUST exist
          echo ""
          echo "   ðŸ” Final verification..."
          
          if [ -f ".droog-embeddings.json" ]; then
            FILE_SIZE=$(stat -f%z .droog-embeddings.json 2>/dev/null || stat -c%s .droog-embeddings.json 2>/dev/null || echo "0")
            echo "   âœ… Index file exists: .droog-embeddings.json"
            echo "   âœ… File size: ${FILE_SIZE} bytes"
            echo "   âœ… File location: $(pwd)/.droog-embeddings.json"
            echo "index_exists=true" >> $GITHUB_OUTPUT
            echo ""
            echo "   File contents (first 200 chars):"
            head -c 200 .droog-embeddings.json
            echo ""
            echo ""
          else
            echo "   âŒ CRITICAL: Index file still doesn't exist!"
            echo "   Creating empty but valid JSON file as last resort..."
            
            # Force create directory if needed
            mkdir -p "$(pwd)"
            
            # Create minimal valid JSON
            echo '{"embeddings":[],"metadata":{"note":"Empty index - forced creation","timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}}' > .droog-embeddings.json
            
            if [ -f ".droog-embeddings.json" ]; then
              echo "   âœ… Created empty index file successfully"
              echo "index_exists=true" >> $GITHUB_OUTPUT
            else
              echo "   âŒ FAILED to create index file even with force creation!"
              echo "   Current directory: $(pwd)"
              echo "   Permissions:"
              ls -ld .
              exit 1
            fi
          fi
          
          echo "=========================================="
          echo "âœ… INDEXING STEP COMPLETE"
          echo "=========================================="
        continue-on-error: false
      
      # Step 8: Run DroogAI Review on calling repository
      - name: Run DroogAI Review
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Verify .droog-ai exists and change to it
          if [ ! -d ".droog-ai" ]; then
            echo "âŒ .droog-ai directory not found"
            echo "Current directory: $(pwd)"
            ls -la
            exit 1
          fi
          cd .droog-ai
          echo "âœ… Changed to .droog-ai directory: $(pwd)"
          
          PR_NUMBER="${{ inputs.pr_number }}"
          POST_FLAG=""
          AUTO_FIX_FLAG=""
          AUTO_APPLY_FLAG=""
          
          if [ "${{ inputs.post_comments }}" = "true" ]; then
            POST_FLAG="--post"
          fi
          
          if [ "${{ inputs.auto_fix }}" = "true" ]; then
            AUTO_FIX_FLAG="--auto-fix"
          fi
          
          if [ "${{ inputs.auto_apply }}" = "true" ]; then
            AUTO_APPLY_FLAG="--auto-apply"
          fi
          
          echo "ðŸš€ Running DroogAI review on ${{ github.repository }} PR #${PR_NUMBER}"
          echo "   Flags: --enterprise ${POST_FLAG} ${AUTO_FIX_FLAG} ${AUTO_APPLY_FLAG}"
          
          # Run review with enterprise features enabled
          node dist/index.js review --repo "${{ github.repository }}" --pr "${PR_NUMBER}" --enterprise ${POST_FLAG} ${AUTO_FIX_FLAG} ${AUTO_APPLY_FLAG} || true
          
          # Copy report.json to workspace root for artifact upload
          # Note: report.json is created in current directory (.droog-ai)
          if [ -f "report.json" ]; then
            cp report.json "${{ github.workspace }}/report.json"
            echo "âœ… Review report generated and copied to workspace root"
          else
            echo "âš ï¸  report.json not found in .droog-ai directory"
            echo "Current directory: $(pwd)"
            echo "Files in current directory:"
            ls -la | head -10
            echo "Creating minimal error report in workspace root"
            echo '{"success":false,"error":"Review failed to generate report","totalIssues":0,"issuesBySeverity":{"high":0,"medium":0,"low":0},"comments":[],"timestamp":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}' > "${{ github.workspace }}/report.json"
          fi
      
      - name: Upload review report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: review-report
          path: report.json
          retention-days: 7
          if-no-files-found: warn

